{% extends 'base.html' %}
{% load static %}
{% block content %}
<!-- Original MUI React component was converted to this Bootstrap + Django template -->

<!-- 
Original React (MUI) version had:
- Image carousel with next/back buttons
- Loading skeletons
- Favorite (heart) toggle button
- Add to booking cart button with disabled state if no copies
- Barcode image display
- Dialog for full image preview
-->

<!-- Test the inclusion -->
{% include 'user/components/appbar.html' %}

<!-- Sidebar -->
{% include 'user/components/drawer.html' %}

<style>
    body {
    margin: 0;
  }

  .main-content {
    margin-left: 250px;  /* width of sidebar */
    padding-top: 90px;   /* height of navbar + some space */
  }

  #favoriteBtn {
    text-decoration: none !important; 
    box-shadow: none !important; 
  }

  #favoriteBtn:hover, 
  #favoriteBtn:focus, 
  #favoriteBtn:active {
    text-decoration: none !important;
    box-shadow: none !important;
    outline: none !important;
  }
</style>

<div class="container mt-4" style="padding-top: 70px;">
  <div class="row">
    <!-- Book Cover with Carousel -->
    <div class="col-md-4 text-center mb-4">
      {% if images|length > 1 %}
      <div id="bookCarousel" class="carousel slide" data-bs-interval="false" data-bs-wrap="false">
        <div class="carousel-inner">
          {% for image in images %}
          <div class="carousel-item {% if forloop.first %}active{% endif %}">
            <img src="{{ image }}" class="d-block w-100 rounded shadow" style="max-height: 400px; object-fit: contain; cursor: pointer;" alt="Book image" data-bs-toggle="modal" data-bs-target="#imageModal" data-image="{{ image }}">
          </div>
          {% endfor %}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#bookCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#bookCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>
      {% elif images|length == 1 %}
      <img src="{{ book.cover_image.url }}" class="img-fluid rounded shadow" style="max-height: 400px; object-fit: contain; cursor: pointer;" alt="Book image" data-bs-toggle="modal" data-bs-target="#imageModal" data-image="{{ images.0 }}">
      {% else %}
      <img src="{% static 'images/no-image-available.png' %}" class="img-fluid rounded shadow" style="max-height: 400px; object-fit: contain;" alt="No image available">
      {% endif %}
      
      <div class="mt-3">
        <button id="addBookingBtn" type="button" class="btn btn-primary w-100 fw-bold" {% if book.copies == 0 %}disabled{% endif %}>
          Add to Booking Cart
        </button>
      </div>
    </div>

    <!-- Book Info -->
    <div class="col-md-8">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2>{{ book.title }}</h2>
        <button id="favoriteBtn" class="btn btn-link p-0 fs-3" title="Toggle favorite">
          {% if is_favorite %}
            <span style="color: red;">&#10084;</span>
          {% else %}
            <span style="color: gray;">&#10084;</span>
          {% endif %}
        </button>
      </div>
      <h5 class="text-muted mb-3">by {{ book.author }}</h5>

      {% if book.genre %}
      <p><strong>Genre:</strong> {{ book.genre.name }}</p>
      {% endif %}
      {% if book.published_date %}
      <p><strong>Published:</strong> {{ book.published_date|date:"F d, Y" }}</p>
      {% endif %}
      {% if book.isbn %}
      <p><strong>ISBN:</strong> {{ book.isbn }}</p>
      {% endif %}
      {% if book.language %}
      <p><strong>Language:</strong> {{ book.language }}</p>
      {% endif %}
      {% if book.page_count %}
      <p><strong>Pages:</strong> {{ book.page_count }}</p>
      {% endif %}
      {% if book.copies is not None %}
      <p class="{% if book.copies == 0 %}text-danger{% endif %}"><strong>Total Copies:</strong> {{ book.copies|default:"Unavailable" }}</p>
      {% endif %}

      {% if book.description %}
      <hr />
      <h5>Description</h5>
      <p style="white-space: pre-line">{{ book.description }}</p>
      {% endif %}

      {% if barcode_url %}
      <div class="mt-4">
        <h6>Barcode:</h6>
        <img src="{{ barcode_url }}" alt="Barcode" style="max-width: 250px; height: auto;">
      </div>
      {% else %}
      <p class="text-danger">Barcode image not available</p>
      {% endif %}
    </div>
  </div>

  <div class="mt-4 text-center">
    <a href="{% url 'user_library' %}" class="btn btn-outline-primary">‚Üê Back to Library</a>
  </div>
</div>

<!-- Modal for full size image -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="modalImage" src="" alt="Full size" class="img-fluid" style="max-height: 80vh; object-fit: contain;">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  var imageModal = document.getElementById('imageModal');
  var modalImage = document.getElementById('modalImage');
  imageModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var imageSrc = button.getAttribute('data-image');
    modalImage.src = imageSrc;
  });

  document.getElementById('favoriteBtn').addEventListener('click', function () {
    alert('Favorite toggle clicked - implement AJAX to backend');
  });

  document.getElementById('addBookingBtn').addEventListener('click', function () {
    alert('Add to booking cart clicked - implement AJAX to backend');
  });
</script>

{% endblock %}
