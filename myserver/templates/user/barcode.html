{% extends 'base.html' %} {% load static %} {% block content %}

<!-- Navbar -->
{% include 'user/components/appbar.html' %}

<!-- Sidebar -->
{% include 'user/components/drawer.html' %}

<!-- Main Container -->
<div class="container py-5 mt-4" style="padding-top: 100px; max-width: 700px">
  <h3 class="text-center fw-bold mb-4 mt-6">ðŸ“· Scan the Barcode</h3>

  <!-- Error Message -->
  <div id="error-alert" class="alert alert-danger d-none text-center"></div>

  <!-- Video Scanner -->
  <div class="text-center mb-4">
    <video
      id="video"
      autoplay
      playsinline
      class="w-100 rounded shadow-sm"
      style="max-height: 400px"
    ></video>
    <canvas id="canvas" style="display: none"></canvas>
    <button id="toggleScan" class="btn btn-primary mt-3 w-100">
      Stop Scanning
    </button>
  </div>

  <!-- Manual Barcode Input -->
  <div class="mb-4">
    <label for="manualBarcode" class="form-label"
      >Or enter barcode manually:</label
    >
    <div class="input-group">
      <input
        type="text"
        id="manualBarcode"
        class="form-control"
        placeholder="Enter barcode"
      />
      <button
        class="btn btn-secondary"
        onclick="fetchBook(document.getElementById('manualBarcode').value)"
      >
        Submit
      </button>
    </div>
  </div>

  <!-- Book Info Card -->
  <div
    id="bookInfo"
    class="card d-none mx-auto shadow-sm"
    style="max-width: 100%"
  >
    <img
      id="coverImage"
      class="card-img-top"
      alt="Book Cover"
      style="height: 300px; object-fit: cover"
    />
    <div class="card-body">
      <h5 id="bookTitle" class="card-title fw-bold"></h5>
      <p id="bookAuthor" class="card-text"></p>
      <p id="bookGenre" class="card-text"></p>
      <p id="bookISBN" class="card-text"></p>
      <p id="bookPublished" class="card-text"></p>
      <p id="bookDescription" class="card-text small text-muted"></p>
      <div class="d-grid">
        <button class="btn btn-success mt-3" onclick="resetScanner()">
          Scan Another
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JSQR Scanner Script -->
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
  let scanning = true;
  let stream = null;
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const context = canvas.getContext("2d");
  const toggleBtn = document.getElementById("toggleScan");

  function startCamera() {
    navigator.mediaDevices
      .getUserMedia({ video: { facingMode: "environment" } })
      .then((mediaStream) => {
        stream = mediaStream;
        video.srcObject = stream;
        video.play();
        scanning = true;
        toggleBtn.textContent = "Stop Scanning";
        requestAnimationFrame(scan);
      })
      .catch((err) => showError("Camera access denied or not available."));
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach((track) => track.stop());
    }
    scanning = false;
    video.srcObject = null;
    toggleBtn.textContent = "Start Scanning";
    video.poster = "";
    video.classList.add("bg-secondary");
    video.innerHTML = "<div class='text-white p-4'>Camera is off</div>";
  }

  toggleBtn.onclick = () => {
    if (scanning) {
      stopCamera();
    } else {
      startCamera();
    }
  };

  function scan() {
    if (!scanning) return;
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      if (code) {
        fetchBook(code.data);
        stopCamera();
      }
    }
    requestAnimationFrame(scan);
  }

  function fetchBook(barcode) {
    if (!barcode) {
      showError("Please enter a barcode.");
      return;
    }
    fetch(`/api/book/${barcode}/`)
      .then((res) => {
        if (!res.ok) throw new Error("Book not found.");
        return res.json();
      })
      .then((data) => showBookInfo(data))
      .catch((err) => showError(err.message));
  }

  function showBookInfo(data) {
    document.getElementById("error-alert").classList.add("d-none");
    document.getElementById("bookInfo").classList.remove("d-none");
    document.getElementById("coverImage").src =
      data.cover_url || "{% static 'default-book-cover.jpg' %}";
    document.getElementById("bookTitle").textContent = data.title;
    document.getElementById("bookAuthor").textContent = "By: " + data.author;
    document.getElementById("bookGenre").textContent = "Genre: " + data.genre;
    document.getElementById("bookISBN").textContent =
      "ISBN: " + (data.isbn || "N/A");
    document.getElementById("bookPublished").textContent =
      "Published: " + new Date(data.published_date).toDateString();
    document.getElementById("bookDescription").textContent = data.description;
  }

  function showError(msg) {
    const alert = document.getElementById("error-alert");
    alert.textContent = msg;
    alert.classList.remove("d-none");
    setTimeout(() => alert.classList.add("d-none"), 4000);
  }

  function resetScanner() {
    document.getElementById("bookInfo").classList.add("d-none");
    document.getElementById("manualBarcode").value = "";
    startCamera();
  }

  window.addEventListener("DOMContentLoaded", () => {
    startCamera();
  });
</script>

{% endblock %}
